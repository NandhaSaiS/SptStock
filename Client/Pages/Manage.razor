@page "/manage"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using StockManagementSystem.Shared.Models
@using StockManagementSystem.Client.Services
@using Microsoft.AspNetCore.Components.Forms
@inject StockService StockService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

<PageTitle>Manage Stock</PageTitle>

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>‚öôÔ∏è Manage Stock Items</h2>
            <p class="text-muted">Add, edit, or delete stock items</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-secondary me-2" @onclick="NavigateToDashboard">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <button class="btn btn-danger" @onclick="Logout">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <button class="btn btn-primary me-2" @onclick="ShowAddModal">
                <i class="bi bi-plus-circle"></i> Add New Item
            </button>
            <button class="btn btn-success me-2" @onclick="ShowUploadModal">
                <i class="bi bi-upload"></i> Bulk Upload Excel
            </button>
            <button class="btn btn-info" @onclick="DownloadTemplate">
                <i class="bi bi-download"></i> Download Template
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading...</p>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> All Stock Items (@stockItems.Count)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>S.No</th>
                                <th>Item Name</th>
                                <th>Quantity</th>
                                <th>Created By</th>
                                <th>Updated By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in stockItems)
                            {
                                <tr>
                                    <td>@item.SNo</td>
                                    <td><strong>@item.ItemName</strong></td>
                                    <td>
                                        <span class="badge @GetQuantityBadgeClass(item.Quantity)">
                                            @item.Quantity
                                        </span>
                                    </td>
                                    <td>@item.CreatedBy</td>
                                    <td>@(item.UpdatedBy ?? "-")</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning me-1" @onclick="() => ShowEditModal(item)">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteItem(item.SNo)">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<!-- Add/Edit Modal -->
@if (showModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditMode ? "‚úèÔ∏è Edit" : "‚ûï Add New") Stock Item</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <EditForm Model="currentItem" OnSubmit="SaveItem">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Item Name *</label>
                            <input @bind-value="@currentItem.ItemName" class="form-control" />
                            <ValidationMessage For="@(() => currentItem.ItemName)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity *</label>
                            <input @bind-value="@currentItem.Quantity" class="form-control" />
                            <ValidationMessage For="@(() => currentItem.Quantity)" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Upload Modal -->
@if (showUploadModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üì§ Bulk Upload Stock Items</h5>
                    <button type="button" class="btn-close" @onclick="CloseUploadModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Excel File (.xlsx)</label>
                        <InputFile OnChange="HandleFileSelected" class="form-control" accept=".xlsx,.xls" />
                        <div class="form-text">
                            File should contain: ItemName, Quantity
                        </div>
                    </div>
                    @if (selectedFile != null)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-file-earmark-excel"></i> Selected: <strong>@selectedFile.Name</strong> (@(selectedFile.Size / 1024)KB)
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseUploadModal">Cancel</button>
                    <button type="button" class="btn btn-success" @onclick="UploadExcel" disabled="@(selectedFile == null || isUploading)">
                        @if (isUploading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-upload"></i> Upload
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {



    private List<StockItem> stockItems = new();
    private StockItem currentItem = new StockItem()
    {
        ItemName = string.Empty,
        Quantity = 0,
        CreatedDate = DateTime.Now,
        CreatedBy = "admin"
    };
    private bool showModal = false;
    private bool showUploadModal = false;
    private bool isEditMode = false;
    private bool isLoading = true;
    private bool isUploading = false;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private IBrowserFile? selectedFile;

    protected override async Task OnInitializedAsync()
    {
        await LoadStockItems();
    }

    private async Task LoadStockItems()
    {
        isLoading = true;
        stockItems = await StockService.GetAllStockItems();
        isLoading = false;
    }

    private void ShowAddModal()
    {
        currentItem = new StockItem()
        {
            ItemName = string.Empty,
            Quantity = 0,
            CreatedDate = DateTime.Now,
            CreatedBy = "admin"
        };
        isEditMode = false;
        showModal = true;
    }

    private void ShowEditModal(StockItem item)
    {
        currentItem = new StockItem
        {
            SNo = item.SNo,
            ItemName = item.ItemName,
            Quantity = item.Quantity,
            CreatedBy = item.CreatedBy,
        };
        isEditMode = true;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        currentItem = new();
    }

    private async Task SaveItem()
    {
        try
        {
            bool success;
            if (isEditMode)
            {
                success = await StockService.UpdateStockItem(currentItem.SNo, currentItem);
                successMessage = success ? "Stock item updated successfully!" : string.Empty;
            }
            else
            {
                success = await StockService.CreateStockItem(currentItem);
                successMessage = success ? "Stock item added successfully!" : string.Empty;
            }

            if (success)
            {
                await LoadStockItems();
                CloseModal();
            }
            else
            {
                errorMessage = "Failed to save stock item.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task DeleteItem(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this item?"))
        {
            var success = await StockService.DeleteStockItem(id);
            if (success)
            {
                successMessage = "Stock item deleted successfully!";
                await LoadStockItems();
            }
            else
            {
                errorMessage = "Failed to delete stock item.";
            }
        }
    }

    private void ShowUploadModal()
    {
        selectedFile = null;
        showUploadModal = true;
    }

    private void CloseUploadModal()
    {
        showUploadModal = false;
        selectedFile = null;
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }

    private async Task UploadExcel()
    {
        if (selectedFile == null) return;

        isUploading = true;
        try
        {
            var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(selectedFile.OpenReadStream(maxAllowedSize: 10485760));
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            content.Add(fileContent, "file", selectedFile.Name);

            var (success, message) = await StockService.UploadExcel(content);

            if (success)
            {
                successMessage = message;
                await LoadStockItems();
                CloseUploadModal();
            }
            else
            {
                errorMessage = message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Upload failed: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private async Task DownloadTemplate()
    {
        var fileBytes = await StockService.DownloadTemplate();
        if (fileBytes != null)
        {
            await JSRuntime.InvokeVoidAsync("downloadFile", "StockTemplate.xlsx", Convert.ToBase64String(fileBytes));
        }
    }

    private string GetQuantityBadgeClass(int quantity)
    {
        if (quantity == 0) return "bg-danger";
        if (quantity < 50) return "bg-warning text-dark";
        return "bg-success";
    }

    private void NavigateToDashboard()
    {
        Navigation.NavigateTo("/");
    }

    private async Task Logout()
    {
        await AuthService.Logout();
        Navigation.NavigateTo("/login");
    }
}
